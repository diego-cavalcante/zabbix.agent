############################################################################################################################################
# Desenvolvido por Diego Cavalcante                                                                                                        #
# Script: agent.zabbix.ps1                                                                                                                 #
# E-Mail: diego@suportecavalcante.com.br                                                                                                   #
# Skype: suportecavalcante                                                                                                                 #
# Criação = Versão 1.0.0 29/08/2017 (Script Básico de instalação do Zabbix Agent).                                                         #
# Update  = Versão 1.1.0 30/08/2017 (ADD Campo "Pasta de Instalação", ADD Selecionar Porta, ADD Liberar Firewall).                         #        
# Update  = Versão 1.2.0 31/08/2017 (ADD Opção REMOVE Agent Full e cria um backup da pasta original com a data atual).                     #
# Update  = Versão 1.3.0 31/08/2017 (ADD Opção de selecionar a versão de instalação).                                                      #
# Update  = Versão 1.4.0 01/09/2017 (ADD Teste de conectividade na porta 10051 do Server/Proxy).                                           #
# Update  = Versão 1.5.0 02/09/2017 (ADD Opção CHANGE para Upgrade/Downgrade de versão do Zabbix Agent).                                   #
# Update  = Versão 1.6.0 05/09/2017 (ADD INSTALL Opção que verifica se a versão escolhida existe no instalador).                           #
# Update  = Versão 1.7.0 08/12/2017 (ADD Variável que substitui no zabbix_agentd.conf tudo que foi digitado interativamente).              #
# Update  = Versão 1.8.0 09/12/2017 (ADD CHANGE Opção que verifica se a versão escolhida existe no instalador).                            #
# Update  = Versão 1.9.0 11/12/2017 (Contribuição Mário Alves - ADD parâmetros para instalação via compartilhamento e validações).         #
# Update  = Versão 1.9.1 16/12/2017 (Obrigado @amarodefarias - Correção ao fazer upgrade/downgrade em diretórios que contêm espaços).      #
#                                                                                                                                          #
# 1º O Script tem como função dar interatividade na instalação do Zabbix Agent.                                                            #
# 2º Oferecer opções de remoção total, upgrade e downgrade de versão de forma simples e interativa.                                        #
# 3º Fornece ao Administrador um padrão unificado de instalação do Zabbix Agent, facilitando upgrades/downgrades futuros.                  #
# 4º Diretório padrão de Scripts: c:\seupadrao\monitoramento\scripts\                                                                      #
# 5º Diretório padrão de UserParameters: c:\seupadrao\monitoramento\userparameters\                                                        #
# 6º Fornece um resumo de instalação, teste de conexão com server/proxy, liberação automática da porta no firewall do windows.             #
# 7º Campos obrigatórios para Intalação:                                                                                                   #
# Versão, Diretório, Server, ServerActive, Hostname, Timeout, EnableRemoteCommands, LogRemoteCommands, ListenPort                          #
############################################################################################################################################

############################################################################################################################################
# Script válido apenas para as versões do Zabbix Agent                                                                                     #
############################################################################################################################################
# 3.4.x = 3.4.0 até 3.4.4                                                                                                                  #
# 3.2.x = 3.2.0 até 3.2.10                                                                                                                 #
# 3.0.x = 3.0.0 até 3.0.13                                                                                                                 #
############################################################################################################################################

############################################################################################################################################
# Requisitos                                                                                                                               #
############################################################################################################################################
# Abrir o PowerShell como Administrador (liberação de porta no Firewall e Serviço do Zabbix Agent necessitam de privilégios elevados.)     #
# Com o Powershell aberto, execute o comando "Set-Executionpolicy Unrestricted" sem aspas e confirme a alteração.                          #
############################################################################################################################################

############################################################################################################################################
# Parâmetros de Uso                                                                                                                        #
############################################################################################################################################

############################################################################################################################################
# Instalação LOCAL                                                                                                                         #
############################################################################################################################################
# 1º Acesse o Host onde o Zabbix Agent será instalado, removido ou alterado.                                                               #
# 2º Abra o Powershell como Administrador                                                                                                  #
# 3º Execute o comando "Set-Executionpolicy Unrestricted" sem aspas e confirme a alteração.                                                #
# 4º Baixar agent.zabbix.zip                                                                                                               #
# 5º Descompactar agent.zabbix.zip em c:\                                                                                                  #
# 6º cd c:\agent.zabbix                                                                                                                    #
#                                                                                                                                          #
# Para Instalar execute o comando                                                                                                          #
# powershell.exe -noprofile -executionpolicy bypass -File agent.zabbix.ps1 LOCALINSTALL                                                    #
# Para Remover execute o comando                                                                                                           #
# powershell.exe -noprofile -executionpolicy bypass -File agent.zabbix.ps1 LOCALREMOVE                                                     #
# Para Upgrade/Downgrade execute o comando                                                                                                 #
# powershell.exe -noprofile -executionpolicy bypass -File agent.zabbix.ps1 LOCALCHANGE                                                     #
#                                                                                                                                          #
############################################################################################################################################

############################################################################################################################################
# Instalação REDE                                                                                                                          #
############################################################################################################################################
# Preparando instalador em rede ############################################################################################################
# 1º Acesse seu FileServer                                                                                                                 #
# 2º Baixar agent.zabbix.zip                                                                                                               #
# 3º Descompactar agent.zabbix.zip em seu compartilhamento, ex: \\IPSERVIDOR\compartilhamento\                                             #
# 4º Acesse \\IPSERVIDOR\compartilhamento\agent.zabbix                                                                                     #
# 5º Edite o arquivo agent.zabbix.ps1 e mude as variáveis abaixo de acordo com sua estrutura.                                              #
#                                                                                                                                          #
# $INSTALADOR = "agent.zabbix"                                                                                                             #
# $SRV = "\\IPSERVIDOR"                                                                                                                    #
# $SHARE = "$SRV\compartilhamento\$INSTALADOR"                                                                                             #
#                                                                                                                                          #
# Preparando Host ##########################################################################################################################
# 1º Acesse o Host onde o Zabbix Agent será instalado, removido ou alterado.                                                               #
# 2º Abra o Powershell como Administrador                                                                                                  #
# 3º Execute o comando "Set-Executionpolicy Unrestricted" sem aspas e confirme a alteração.                                                #
# 4º Caso o Host já tenha acesso a pasta compartilhada dita acima, ignore a etapa 5º abaixo e pule direto para a instalação.               #
# 5º Caso o Host ainda não tenha acesso, no powershell, execute o comando "net use \\IPDOSERVIDOR senha /USER:DOMINIO\usuario" sem aspas.  #
#                                                                                                                                          #
# Comandos de instalação, remoção, upgrade/downgrade #######################################################################################
# Para Instalar execute o comando                                                                                                          #
# powershell.exe -noprofile -executionpolicy bypass -File \\IPSERVIDOR\compartilhamento\agent.zabbix\agent.zabbix.ps1 REDEINSTALL          #
# Para Remover execute o comando                                                                                                           #
# powershell.exe -noprofile -executionpolicy bypass -File \\IPSERVIDOR\compartilhamento\agent.zabbix\agent.zabbix.ps1 REDEREMOVE           #
# Para Upgrade/Downgrade execute o comando                                                                                                 #
# powershell.exe -noprofile -executionpolicy bypass -File \\IPSERVIDOR\compartilhamento\agent.zabbix\agent.zabbix.ps1 REDECHANGE           #
#                                                                                                                                          #
############################################################################################################################################

############################################################################################################################################
# Validações executadas                                                                                                                    #
############################################################################################################################################
#                                                                                                                                          #
# Windows Server 2003 R2 x64            = Versão Powershell: 1.0      = Validado: SIM
# Windows Server 2012 Standard x64      = Versão Powershell: 3.0      = Validado: SIM                                                      #
# Windows Server 2016 Standard x64      = Versão Powershell: 4.0      = Validado: SIM                                                      #
# Windows Server 2008 Datacenter x64    = Versão Powershell: 2.0      = Validado: SIM                                                      #
# Windows Server 2008 R2 Enterprise x64 = Versão Powershell: 2.0, 4.0 = Validado: SIM                                                      #
# Windows Server 2008 R2 Fundation x64  = Versão Powershell: 4.0      = Validado: SIM                                                      #
# Windows 7 Ultimate x64                = Versão Powershell: 2.0      = Validado: SIM                                                      #
# Windows 7 Profissional x86            = Versão Powershell: 2.0      = Validado: SIM                                                      #
# Windows 10 Ultimate x64               = Versão Powershell: 4.0      = Validado: SIM                                                      #
#                                                                                                                                          #
############################################################################################################################################
